<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>BlackBoxOptim · Agents.jl</title><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script><link href="https://fonts.googleapis.com/css?family=Montserrat|Source+Code+Pro&amp;display=swap" rel="stylesheet" type="text/css"/></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../"><img src="../../assets/logo.png" alt="Agents.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit">Agents.jl</span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Introduction</a></li><li><a class="tocitem" href="../../tutorial/">Tutorial</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Examples</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../schelling/">Schelling&#39;s segregation model</a></li><li><a class="tocitem" href="../sir/">SIR model for the spread of COVID-19</a></li><li><a class="tocitem" href="../social_distancing/">Continuous space social distancing for COVID-19</a></li><li><a class="tocitem" href="../wealth_distribution/">Wealth distribution</a></li><li><a class="tocitem" href="../forest_fire/">Forest fire</a></li><li><a class="tocitem" href="../game_of_life_2D_CA/">Conway&#39;s game of life</a></li><li><a class="tocitem" href="../wright-fisher/">Wright-Fisher model of evolution</a></li><li><a class="tocitem" href="../hk/">Hegselmann-Krause opinion dynamics</a></li><li><a class="tocitem" href="../flock/">Flocking</a></li><li><a class="tocitem" href="../daisyworld/">Daisyworld</a></li><li><a class="tocitem" href="../predator_prey/">Predator-Prey</a></li><li><a class="tocitem" href="../growing_bacteria/">Bacteria Growth</a></li></ul></li><li><a class="tocitem" href="../../models/">Predefined Models</a></li><li><a class="tocitem" href="../../api/">API</a></li><li><a class="tocitem" href="../../interact/">Interactive application</a></li><li><input class="collapse-toggle" id="menuitem-7" type="checkbox" checked/><label class="tocitem" for="menuitem-7"><span class="docs-label">Ecosystem Integration</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../diffeq/">DifferentialEquations.jl</a></li><li class="is-active"><a class="tocitem" href>BlackBoxOptim</a></li></ul></li><li><a class="tocitem" href="../../mesa/">Comparison against Mesa (Python)</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Ecosystem Integration</a></li><li class="is-active"><a href>BlackBoxOptim</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>BlackBoxOptim</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaDynamics/Agents.jl/blob/master/examples/optim.jl" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Optimizing-agent-based-models"><a class="docs-heading-anchor" href="#Optimizing-agent-based-models">Optimizing agent-based models</a><a id="Optimizing-agent-based-models-1"></a><a class="docs-heading-anchor-permalink" href="#Optimizing-agent-based-models" title="Permalink"></a></h1><p>Agent-based models (ABMs) are computationally more expensive than analytical models, and can have many parameters. Sometimes we need to fine-tune a model&#39;s parameters to a specific outcome. Brute-force algorithms can take too long for testing each parameter setting. Even if it was feasbile to run the model for every parameter setting, it would not be enough because ABMs are stochastic and the effect of a parameter setting should be derived from running the model several times and taking its average behavior.</p><p>Here we show how to use the evolutionary algorithms in <a href="https://github.com/robertfeldt/BlackBoxOptim.jl">BlackBoxOptim.jl</a> with Agents.jl, to optimize the parameters of an epidemiological model (SIR). We explain this model in detail in <a href="../sir/#SIR-model-for-the-spread-of-COVID-19">SIR model for the spread of COVID-19</a>. For brevity here, we just import it.</p><pre><code class="language-julia">include(&quot;siroptim.jl&quot;) # From the examples directory</code></pre><p>Now we need to define a cost function. The cost function takes as agruments the model parameters that we want to tune, here migration rate, death rate, transmission rate when an infected person has been (not) detected (<code>β_det</code>, <code>β_und</code>), infection period, reinfection probability, and time until the infection is detected. The function returns one or more numbers as the objective to be minimized. Here, we try to minimize the number of infected people after 50 days.</p><pre><code class="language-julia">using BlackBoxOptim, Random
using Statistics: mean

function cost(x)
    model = model_initiation(;
        Ns = [500, 500, 500],
        migration_rate = x[1],
        death_rate = x[2],
        β_det = x[3],
        β_und = x[4],
        infection_period = x[5],
        reinfection_probability = x[6],
        detection_time = x[7],
    )

    infected_fraction(model) =
        count(a.status == :I for a in allagents(model)) / nagents(model)

    _, data = run!(
        model,
        agent_step!,
        50;
        mdata = [infected_fraction],
        when_model = [50],
        replicates = 10,
    )

    return mean(data.infected_fraction)
end</code></pre><pre class="documenter-example-output">cost (generic function with 1 method)</pre><p>Because ABMs are stochastic, we run 10 replicates and take the average fraction of infected people after 50 days</p><p>We can now test the function cost with some reasonable parameter values.</p><pre><code class="language-julia">Random.seed!(10)

x0 = [
    0.2,  # migration_rate = 0.2,
    0.1,  # death_rate = 0.1,
    0.05, # β_det = 0.05,
    0.3,  # β_und = 0.3,
    10,   # infection_period = 10,
    0.1,  # reinfection_probability = 0.1,
    5,    # detection_time = 5,
]
cost(x0)</code></pre><pre class="documenter-example-output">0.9348851444455306</pre><p>After 50 days, 94% of the population is infected.</p><p>We let the optimization algorithm change parameters to minimize the number of infected individuals. Note that we can limit the allowed range for each parameter separately.</p><pre><code class="language-julia">result = bboptimize(
    cost,
    SearchRange = [
        (0.0, 1.0),
        (0.0, 1.0),
        (0.0, 1.0),
        (0.0, 1.0),
        (7.0, 13.0),
        (0.0, 1.0),
        (2.0, 6.0),
    ],
    NumDimensions = 7,
    MaxTime = 20,
)
best_fitness(result)</code></pre><pre class="documenter-example-output">0.11400568097805301</pre><p>The fraction of the infected is down to 11%. Parameter values that give this result are:</p><pre><code class="language-julia">best_candidate(result)</code></pre><pre class="documenter-example-output">7-element Array{Float64,1}:
  0.14295189314028073
  0.9563511728519357
  0.11642612651074881
  0.1247861896135058
 12.633440015975424
  0.0019240394102884694
  3.8685012358501547</pre><p>We notice that the death rate is 96%, and transmission rates have also increased, while reinfection probability is much smaller. When all the infected indiduals die, infection doesn&#39;t transmit. Let&#39;s modify the cost function to also keep the mortality rate low.</p><p>This can be tested by running the model with the new parameter values:</p><pre><code class="language-julia">x = best_candidate(result)

Random.seed!(0)

model = model_initiation(;
    Ns = [500, 500, 500],
    migration_rate = x[1],
    death_rate = x[2],
    β_det = x[3],
    β_und = x[4],
    infection_period = x[5],
    reinfection_probability = x[6],
    detection_time = x[7],
)

_, data =
    run!(model, agent_step!, 50; mdata = [nagents], when_model = [50], replicates = 10)

mean(data.nagents)</code></pre><pre class="documenter-example-output">1358.9</pre><p>About 10% of the population dies with these parameters.</p><p>We can define a multi-objective cost function that minimizes the number of infected and deaths.</p><pre><code class="language-julia">function cost_multi(x)
    model = model_initiation(;
        Ns = [500, 500, 500],
        migration_rate = x[1],
        death_rate = x[2],
        β_det = x[3],
        β_und = x[4],
        infection_period = x[5],
        reinfection_probability = x[6],
        detection_time = x[7],
    )

    initial_size = nagents(model)

    infected_fraction(model) =
        count(a.status == :I for a in allagents(model)) / nagents(model)
    n_fraction(model) = -1.0 * nagents(model) / initial_size

    _, data = run!(
        model,
        agent_step!,
        50;
        mdata = [infected_fraction, n_fraction],
        when_model = [50],
        replicates = 10,
    )

    return mean(data.infected_fraction), mean(data.n_fraction)
end</code></pre><pre class="documenter-example-output">cost_multi (generic function with 1 method)</pre><p>The cost of our initial parameter values is high: most of the population (96%) is infected and 22% die.</p><pre><code class="language-julia">cost_multi(x0)</code></pre><pre class="documenter-example-output">(0.9613671038668243, -0.7817999999999999)</pre><p>Let&#39;s minimize this multi-objective cost function. We need to define the optimization method for multi-objective functions:</p><pre><code class="language-julia">result = bboptimize(
    cost_multi,
    Method = :borg_moea,
    FitnessScheme = ParetoFitnessScheme{2}(is_minimizing = true),
    SearchRange = [
        (0.0, 1.0),
        (0.0, 1.0),
        (0.0, 1.0),
        (0.0, 1.0),
        (7.0, 13.0),
        (0.0, 1.0),
        (2.0, 6.0),
    ],
    NumDimensions = 7,
    MaxTime = 55,
)</code></pre><pre class="documenter-example-output">BlackBoxOptim.OptimizationResults(&quot;borg_moea&quot;, &quot;Max time (55.0 s) reached&quot;, 1, 1.597326505456005e9, 63.777060985565186, BlackBoxOptim.DictChain{Symbol,Any}[BlackBoxOptim.DictChain{Symbol,Any}[Dict{Symbol,Any}(:RngSeed =&gt; 774292,:NumDimensions =&gt; 7,:MaxTime =&gt; 55.0,:SearchRange =&gt; [(0.0, 1.0), (0.0, 1.0), (0.0, 1.0), (0.0, 1.0), (7.0, 13.0), (0.0, 1.0), (2.0, 6.0)],:Method =&gt; :borg_moea,:FitnessScheme =&gt; BlackBoxOptim.ParetoFitnessScheme{2,Float64,true,typeof(sum)}(sum),:MaxFuncEvals =&gt; 0,:MaxSteps =&gt; 0),Dict{Symbol,Any}()],Dict{Symbol,Any}(:FitnessScheme =&gt; BlackBoxOptim.ScalarFitnessScheme{true}(),:NumDimensions =&gt; :NotSpecified,:PopulationSize =&gt; 50,:MaxTime =&gt; 0.0,:SearchRange =&gt; (-1.0, 1.0),:Method =&gt; :adaptive_de_rand_1_bin_radiuslimited,:MaxNumStepsWithoutFuncEvals =&gt; 100,:RngSeed =&gt; 1234,:MaxFuncEvals =&gt; 0,:SaveTrace =&gt; false…)], 51, BlackBoxOptim.EpsBoxDominanceFitnessScheme{2,Float64,true,typeof(sum)}([0.1, 0.1], sum), BlackBoxOptim.EpsBoxArchiveOutput{2,Float64,BlackBoxOptim.EpsBoxDominanceFitnessScheme{2,Float64,true,typeof(sum)}}((0.0002010274938093588, -0.9970666666666664), [0.33047213757587385, 0.4162200712338514, 0.19614410158370602, 0.001988769978834718, 7.602018447426495, 0.5364418966125286, 4.025083782376916], BlackBoxOptim.FrontierIndividualWrapper{Tuple{Float64,Float64},BlackBoxOptim.IndexedTupleFitness{2,Float64}}[BlackBoxOptim.FrontierIndividualWrapper{Tuple{Float64,Float64},BlackBoxOptim.IndexedTupleFitness{2,Float64}}(BlackBoxOptim.FrontierIndividual{BlackBoxOptim.IndexedTupleFitness{2,Float64}}(BlackBoxOptim.IndexedTupleFitness{2,Float64}((0.0002010274938093588, -0.9970666666666664), -0.9968656391728571, (0, -10), 0.029402136823219068), [0.33047213757587385, 0.4162200712338514, 0.19614410158370602, 0.001988769978834718, 7.602018447426495, 0.5364418966125286, 4.025083782376916], 0, 5, 0, 1.597326512750759e9), (0.0002010274938093588, -0.9970666666666664))], BlackBoxOptim.EpsBoxDominanceFitnessScheme{2,Float64,true,typeof(sum)}([0.1, 0.1], sum)), BlackBoxOptim.DummyMethodOutput())</pre><p>With the optimized parameters, about 0.3% of the population dies and 0.02% are infected:</p><pre><code class="language-julia">best_fitness(result)</code></pre><pre class="documenter-example-output">(0.0002010274938093588, -0.9970666666666664)</pre><p>And the tuned parameters are</p><pre><code class="language-julia">best_candidate(result)</code></pre><pre class="documenter-example-output">7-element Array{Float64,1}:
 0.33047213757587385
 0.4162200712338514
 0.19614410158370602
 0.001988769978834718
 7.602018447426495
 0.5364418966125286
 4.025083782376916</pre><p>The algorithm managed to minimize the the number of infected and deaths while still increasing death rate to 42%, reinfection probability to 53%, and migration rates to 33%. The most important change decreasing the transmission rate when individuals are infected and undetected (from 30% to 0.2%).</p><p>Let&#39;s reduce death rate and check the cost:</p><pre><code class="language-julia">x = best_candidate(result)
x[2] = 0.02
cost_multi(x)</code></pre><pre class="documenter-example-output">(0.00046675567423230975, -0.9996666666666666)</pre><p>The fraction of infected increases to 0.04%. This is an interesting result, confirming the importance of social distancing. Without changing infection period and travel rate, even by increasing the transmission rate of the infected and detected (from 5% to 20%), by just decreasing the transmission rate of the undetected individuals, death rate drops 73 times and the number of infected decreases from 96% of the population to 3%.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../diffeq/">« DifferentialEquations.jl</a><a class="docs-footer-nextpage" href="../../mesa/">Comparison against Mesa (Python) »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Thursday 13 August 2020 13:53">Thursday 13 August 2020</span>. Using Julia version 1.5.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
